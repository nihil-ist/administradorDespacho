name: Backend CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: backend  # Asegúrate de que esta carpeta exista

    services:
      mongodb:
        image: mongo:latest
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install

    - name: Wait for MongoDB to be ready
      run: |
        for i in {1..30}; do
          if mongosh --host localhost --port 27017 --eval "db.runCommand({ ping: 1 })" > /dev/null 2>&1; then
            echo "MongoDB está listo!"
            break
          fi
          echo "Esperando a MongoDB... ($i/30)"
          sleep 2
        done
        if [ $i -eq 30 ]; then
          echo "MongoDB no arrancó a tiempo"
          exit 1
        fi

    - name: Start server in background
      env:
        MONGO_URI: mongodb://localhost:27017/testDespacho
        PORT: 3000
      run: |
        # Aseguramos que node escuche en todas las interfaces
        export NODE_ENV=test
        npm start > server.log 2>&1 &
        SERVER_PID=$!
        echo "Servidor iniciado con PID: $SERVER_PID"
        echo $SERVER_PID > server.pid

        # Esperamos a que el puerto esté abierto
        for i in {1..30}; do
          if curl --fail --silent http://localhost:3000/ > /dev/null; then
            echo "Servidor responde en puerto 3000!"
            break
          fi
          echo "Esperando al servidor... ($i/30)"
          sleep 2
        done

        if [ $i -eq 30 ]; then
          echo "Servidor no respondió a tiempo. Logs:"
          cat server.log
          exit 1
        fi

    - name: Test server is running
      run: |
        RESPONSE=$(curl --write-out '%{http_code}' --silent --output /dev/null http://localhost:3000/)
        if [ "$RESPONSE" -eq 200 ]; then
          echo "Servidor responde con 200 OK"
        else
          echo "Error: Código HTTP $RESPONSE"
          echo "Logs del servidor:"
          cat server.log
          exit 1
        fi

    - name: Show server logs on failure
      if: failure()
      run: |
        echo "=== LOGS DEL SERVIDOR ==="
        cat server.log || echo "No hay logs"
